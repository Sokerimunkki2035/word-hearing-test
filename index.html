<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Word Hearing Test — v5-mini</title>
<style>
  :root{--bg:#0b1220;--card:#131a2a;--muted:#91a1b3;--text:#e8eef6;--ok:#2ecc71;--bad:#ff6b6b;--line:#2a3755}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:820px;margin:24px auto;padding:20px}
  .pill{position:fixed;top:10px;right:10px;background:#1c2741;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
  .card{background:#131a2a;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  h1{margin:.2rem 0 1rem 0;font-size:clamp(22px,3.2vw,30px)}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  button{background:#1f2a44;color:var(--text);border:1px solid #2d3a57;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  button.primary{background:linear-gradient(135deg,#19b37b,#11a1ec);border:none}
  button:disabled{opacity:.55;cursor:not-allowed}
  .options{display:grid;gap:10px;margin-top:8px}
  .option{background:#19233a;border:1px solid var(--line);border-radius:12px;padding:12px;cursor:pointer;text-align:left}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  td,th{border-bottom:1px solid #22304b;padding:8px;text-align:left}
  tr.ok td{background:rgba(46,204,113,.08)} tr.bad td{background:rgba(255,107,107,.08)} tr.skip td{background:rgba(200,200,200,.06)}
</style>
</head>
<body>
<div class="pill">Hearing Lab v5-mini • cache-buster v5</div>
<div class="wrap">
  <h1>Word Hearing Test (mini)</h1>
  <p class="small">Hear one English word, pick what you heard, or press <b>I can’t tell</b>. No immediate feedback – summary after 20 words.</p>

  <section class="card">
    <div class="small" id="status">Word 0/20 • Score 0</div>

    <div class="btns">
      <button id="playBtn" class="primary">▶ Play word</button>
      <button id="repeatBtn" disabled>⟳ Repeat</button>
      <button id="skipBtn">I can’t tell</button>
      <button id="nextBtn" disabled>Next</button>
    </div>

    <div class="options" id="options"></div>
  </section>

  <section id="results" class="card" style="margin-top:14px; display:none">
    <h3>Results</h3>
    <div id="summary"></div>
    <table><thead><tr><th>#</th><th>Target</th><th>Your answer</th><th>Outcome</th></tr></thead><tbody id="rows"></tbody></table>
    <div class="btns"><button id="restartBtn">Restart</button></div>
  </section>
</div>

<script>
/* ============ Words & state ============ */
const WORDS = ["cat","cap","cup","cop","cut","cot","boat","goat","note","nose",
  "close","bed","bad","bet","bat","bit","beat","bead","bid","ship","sheep","chip",
  "cheap","sheet","seat","tree","three","free","green","queen","chair","share",
  "pair","bear","pear","coat","coat","phone","tone","stone","home","foam"];
const TOTAL = 20;
let progress = 0, score = 0, currentWord = "", locked = false;
const results = []; // {n,target,answer,outcome}

/* ============ Elements ============ */
const statusEl = document.getElementById('status');
const optionsEl = document.getElementById('options');
const playBtn = document.getElementById('playBtn');
const repeatBtn = document.getElementById('repeatBtn');
const skipBtn = document.getElementById('skipBtn');
const nextBtn = document.getElementById('nextBtn');
const resSec = document.getElementById('results');
const summary = document.getElementById('summary');
const rows = document.getElementById('rows');
const restartBtn = document.getElementById('restartBtn');

/* ============ Speech ============ */
function speak(text){
  if(!('speechSynthesis' in window)){ alert('Speech synthesis not supported in this browser.'); return; }
  const u = new SpeechSynthesisUtterance(text);
  const vs = window.speechSynthesis.getVoices();
  if(vs && vs.length){ u.voice = vs.find(v=>/en/i.test(v.lang)) || vs[0]; }
  u.rate = 0.95; u.pitch = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}
window.speechSynthesis && (window.speechSynthesis.onvoiceschanged = ()=>{});

/* ============ Helpers ============ */
function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

/* ============ Flow ============ */
function startRound(){
  locked = false;
  progress++;
  if(progress > TOTAL){ finish(); return; }
  statusEl.textContent = `Word ${progress}/${TOTAL} • Score ${score}`;
  currentWord = randChoice(WORDS);
  // options
  const opts = new Set([currentWord]);
  while(opts.size < 4){ opts.add(randChoice(WORDS)); }
  const choices = shuffle([...opts]);
  // render
  optionsEl.innerHTML = "";
  choices.forEach(w=>{
    const b=document.createElement('button');
    b.className='option';
    b.textContent=w;
    b.onclick=()=> choose(w);
    optionsEl.appendChild(b);
  });
  repeatBtn.disabled = false;
  nextBtn.disabled = true;
  speak(currentWord);
}
function choose(answer){
  if(locked) return;
  locked = true;
  const ok = (answer === currentWord);
  if(ok) score++;
  results.push({ n: progress, target: currentWord, answer, outcome: ok?'ok':'bad' });
  nextBtn.disabled = false;
}
function skip(){
  if(locked) return;
  locked = true;
  results.push({ n: progress, target: currentWord, answer:'skip', outcome:'skip' });
  nextBtn.disabled = false;
}
function finish(){
  // hide test UI
  document.querySelector('section.card').style.display='none';
  // summary
  const ok = results.filter(r=>r.outcome==='ok').length;
  const bad = results.filter(r=>r.outcome==='bad').length;
  const skipN = results.filter(r=>r.outcome==='skip').length;
  const pct = Math.round(100*ok/Math.max(1,results.length));
  summary.innerHTML = `<div class="pill" style="position:static">OK ${ok} • Wrong ${bad} • I can’t tell ${skipN} → <b>${pct}%</b></div>`;
  rows.innerHTML = results.map(r=>{
    const cls = r.outcome==='ok'?'ok': r.outcome==='bad'?'bad':'skip';
    return `<tr class="${cls}"><td>${r.n}</td><td>${r.target}</td><td>${r.answer}</td><td>${r.outcome}</td></tr>`;
  }).join('');
  resSec.style.display='block';
  // store history (local)
  const runs = JSON.parse(localStorage.getItem('hearingMiniRuns')||'[]');
  runs.unshift({date:new Date().toISOString().slice(0,10), pct});
  localStorage.setItem('hearingMiniRuns', JSON.stringify(runs.slice(0,25)));
}

/* ============ Wiring ============ */
playBtn.onclick = startRound;
repeatBtn.onclick = ()=> currentWord && speak(currentWord);
skipBtn.onclick = skip;
nextBtn.onclick = startRound;
restartBtn.onclick = ()=> location.reload();
</script>
</body>
</html>
