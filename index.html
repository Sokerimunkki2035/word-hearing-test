<!-- Hearing Lab v6.3 ‚Äì November 2025 ‚Äì Build #2300 -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hearing Lab v6.3 ‚Ä¢ Light Bilingual ‚Ä¢ Build #2300</title>
<style>
:root{
  --bg:#fafbfe;--card:#fff;--line:#e5e7eb;--muted:#5b6573;--text:#111827;
  --accent:#2563eb;--ok:#16a34a;--bad:#ef4444;
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:1000px;margin:0 auto;padding:20px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:14px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
button{background:#f3f4f6;border:1px solid var(--line);border-radius:12px;padding:8px 14px;margin:4px;cursor:pointer;font-weight:600}
button.primary{background:linear-gradient(135deg,#60a5fa,#22c55e);color:#fff;border:none}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none}
input[type=text]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;font-size:15px}
.langbtn{border:none;background:#e0e7ff;color:#1e3a8a;border-radius:8px;padding:4px 10px;font-weight:600;margin-left:4px}
footer{margin-top:20px;font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
<h1>Hearing Lab v6.3 ‚Ä¢ Light Bilingual ‚Ä¢ Build #2300</h1>
<div>üåê Language:
 <button id="setEN" class="langbtn">English</button>
 <button id="setFI" class="langbtn">Suomi</button>
</div>

<section id="instructions" class="card">
 <h2 id="t_intro"></h2>
 <ol id="t_steps" class="small"></ol>
 <div><button id="startBtn" class="primary"></button></div>
</section>

<section id="calibration" class="card hidden">
 <h3 id="t_calib"></h3>
 <p id="t_calibInfo" class="small"></p>
 <button id="toneBtn" class="primary">‚ñ∂ Play / Stop 1 kHz</button>
 <button id="toHyper">Next ‚Üí Hyperacusis</button>
</section>

<section id="hyper" class="card hidden">
 <h3 id="t_hyper"></h3>
 <p id="t_hyperInfo" class="small"></p>
 <button id="hyperPlay" class="primary">‚ñ∂ Play next tone</button>
 <button id="hyperReplay">‚ü≥ Replay</button>
 <button id="toWords" class="primary">Next ‚Üí Word test</button>
 <div class="small">Progress: <span id="hyperProg">0</span>/5 freq <span id="hyperHz">‚Äì</span> kHz</div>
 <canvas id="hyperChart" width="700" height="200"></canvas>
</section>

<section id="words" class="card hidden">
 <h3 id="t_wordtest"></h3>
 <div class="small"><span id="t_word"></span> <span id="wIdx">0</span>/10</div>
 <div>
  <button id="playWord" class="primary">‚ñ∂ Play</button>
  <button id="repeatWord">‚ü≥ Repeat</button>
 </div>
 <div>
  <input id="answer" type="text" placeholder="Type / Kirjoita" autocomplete="off">
  <button id="submitAns">Submit</button>
  <button id="skipAns">Ohi / I can‚Äôt tell</button>
 </div>
</section>

<section id="results" class="card hidden">
 <h3 id="t_results"></h3>
 <div id="summary"></div>
 <canvas id="earChart" width="700" height="220"></canvas>
 <button id="restart" class="primary"></button>
</section>

<footer>Hearing Lab v6.3 ‚Ä¢ Build #2300 ‚Ä¢ November 2025</footer>
</div>

<script>
// ---------- text dictionary ----------
const T={EN:{intro:"Test Instructions",steps:["Use good headphones.","Set volume ‚âà 50 %.","During calibration choose a comfortable level.","You can always choose 'I can‚Äôt tell'.","Steps: Calibration ‚Üí Sensitivity ‚Üí Word test ‚Üí Results."],
 start:"‚ñ∂ Start test",calib:"Calibration",calibInfo:"Play 1 kHz tone and choose how it feels.",hyper:"Hyperacusis / Loudness sensitivity",
 hyperInfo:"Play five tones (0.5 ‚Äì 8 kHz) and rate each.",wordtest:"Word test",word:"Word:",results:"Results",restart:"Restart"},
 FI:{intro:"Kuulotestin ohjeet",steps:["K√§yt√§ hyvi√§ kuulokkeita hiljaisessa tilassa.","S√§√§d√§ √§√§ni noin puoleenv√§liin.","Kalibroinnissa valitse miellytt√§v√§ taso.","Voit aina valita 'Ohi / En erota'.","Vaiheet: Kalibrointi ‚Üí √Ñ√§niherkkyys ‚Üí Sanatesti ‚Üí Tulokset."],
 start:"‚ñ∂ Aloita testi",calib:"Kalibrointi",calibInfo:"Soita 1 kHz √§√§ni ja valitse milt√§ tuntuu.",hyper:"√Ñ√§niherkkyystesti",
 hyperInfo:"Soitetaan viisi √§√§nt√§ (0.5‚Äì8 kHz).",wordtest:"Sanatesti",word:"Sana:",results:"Tulokset",restart:"Aloita alusta"}};
let LANG=localStorage.getItem('hl_lang')||'FI';
function setLang(l){LANG=l;localStorage.setItem('hl_lang',l);
 const t=T[LANG];
 document.getElementById('t_intro').textContent=t.intro;
 document.getElementById('t_steps').innerHTML=t.steps.map(s=>`<li>${s}</li>`).join('');
 document.getElementById('startBtn').textContent=t.start;
 document.getElementById('t_calib').textContent=t.calib;
 document.getElementById('t_calibInfo').textContent=t.calibInfo;
 document.getElementById('t_hyper').textContent=t.hyper;
 document.getElementById('t_hyperInfo').textContent=t.hyperInfo;
 document.getElementById('t_wordtest').textContent=t.wordtest;
 document.getElementById('t_word').textContent=t.word;
 document.getElementById('t_results').textContent=t.results;
 document.getElementById('restart').textContent=t.restart;
}
document.getElementById('setEN').onclick=()=>setLang('EN');
document.getElementById('setFI').onclick=()=>setLang('FI');
setLang(LANG);

// ---------- calibration ----------
let actx,osc,gain;
function ensureAudio(){if(actx)return;actx=new (window.AudioContext||window.webkitAudioContext)();osc=actx.createOscillator();gain=actx.createGain();osc.connect(gain).connect(actx.destination);osc.start();gain.gain.value=0;}
function playTone(f){ensureAudio();osc.frequency.value=f;gain.gain.setValueAtTime(0.1,actx.currentTime);}
function stopTone(){if(!gain)return;gain.gain.setValueAtTime(0,actx.currentTime);}
document.getElementById('startBtn').onclick=()=>{document.getElementById('instructions').classList.add('hidden');document.getElementById('calibration').classList.remove('hidden');};
document.getElementById('toneBtn').onclick=()=>{ensureAudio();if(gain.gain.value>0)stopTone();else playTone(1000);};
document.getElementById('toHyper').onclick=()=>{stopTone();document.getElementById('calibration').classList.add('hidden');document.getElementById('hyper').classList.remove('hidden');};

// ---------- hyperacusis ----------
const freqs=[500,1000,2000,4000,8000];let hIndex=0;const ratings=[];
document.getElementById('hyperPlay').onclick=()=>{if(hIndex>=freqs.length)return;playTone(freqs[hIndex]);setTimeout(stopTone,800);document.getElementById('hyperHz').textContent=(freqs[hIndex]/1000).toFixed(1);};
document.getElementById('hyperReplay').onclick=()=>{if(hIndex<freqs.length){playTone(freqs[hIndex]);setTimeout(stopTone,800);}};
document.getElementById('toWords').onclick=()=>{stopTone();document.getElementById('hyper').classList.add('hidden');document.getElementById('words').classList.remove('hidden');startWords();};
function drawHyper(){const ctx=document.getElementById('hyperChart').getContext('2d');ctx.clearRect(0,0,700,200);ctx.fillStyle='#94a3b8';ratings.forEach((r,i)=>{const h=40+i*25;ctx.fillRect(60+i*120,180-h,50,h);ctx.fillText(r.hz/1000+'k',65+i*120,190);});}

// ---------- words ----------
const wordsEN=["cat","dog","car","tree","book","house","road","chair","door","sun"];
const wordsFI=["kissa","koira","auto","puu","kirja","talo","tie","tuoli","ovi","aurinko"];
let list=[],idx=0,ok=0;
function speak(w,lang){const u=new SpeechSynthesisUtterance(w);u.lang=lang==='FI'?'fi-FI':'en-US';window.speechSynthesis.speak(u);}
function startWords(){const lang=LANG;list=(lang==='FI'?wordsFI:wordsEN);idx=0;ok=0;nextWord();}
function nextWord(){if(idx>=list.length){finish();return;}document.getElementById('wIdx').textContent=idx+1;speak(list[idx],LANG);}
document.getElementById('playWord').onclick=()=>speak(list[idx],LANG);
document.getElementById('repeatWord').onclick=()=>speak(list[idx],LANG);
function submit(skip){const ans=skip?'skip':document.getElementById('answer').value.trim();if(ans.toLowerCase()===list[idx].toLowerCase())ok++;idx++;document.getElementById('answer').value='';nextWord();}
document.getElementById('submitAns').onclick=()=>submit(false);
document.getElementById('skipAns').onclick=()=>submit(true);
function finish(){document.getElementById('words').classList.add('hidden');document.getElementById('results').classList.remove('hidden');document.getElementById('summary').textContent='Score '+ok+'/10';drawEarChart();}
function drawEarChart(){const ctx=document.getElementById('earChart').getContext('2d');ctx.clearRect(0,0,700,220);ctx.fillStyle='#60a5fa';const h=(ok/10)*180;ctx.fillRect(100,200-h,80,h);ctx.fillStyle='#111';ctx.fillText(ok+'/10',110,190-h);}
document.getElementById('restart').onclick=()=>location.reload();
</script>
</body>
</html>
